# 🐪 骆驼大赛 - 多人在线版

现在支持多人在线游玩啦！

## ✨ 新功能：页面刷新后状态保持

现在刷新页面后会自动恢复到之前的状态：
- 🔄 **房间等待**：自动重新连接到房间
- 🎮 **游戏进行中**：保持游戏进度
- 💾 **玩家信息**：记住你的名字和选择

再也不用担心误刷新页面了！

## 🚀 快速开始

### 1. 启动多人游戏服务器和前端（推荐）

```bash
npm run start:all
```

这个命令会同时启动：
- 多人游戏服务器（端口 3001）
- 前端开发服务器（端口 5173）

### 2. 或者分别启动

**启动多人游戏服务器：**
```bash
npm run server:dev
```

**启动前端：**
```bash
npm run dev
```

## 🎮 游戏模式

### 单人模式
- 支持1-8个真人玩家
- 可添加AI玩家
- 本地游玩

### 多人联机模式
- 支持2-8个真人玩家
- 实时在线对战
- 创建/加入房间
- 选择角色和准备系统

## 🌐 多人游戏功能

### 大厅系统
- **创建房间**：成为房主，创建新房间并获得6位房间代码
- **加入房间**：
  - 输入房间代码直接加入
  - 从房间列表选择加入
- **房间列表**：查看所有可用的公开房间

### 房间等待
- 玩家列表显示
- 角色选择（每个角色限一人）
- 准备系统
- 房主控制游戏开始
- 实时同步玩家状态
- **刷新后自动重连** ✨

### 游戏进行中
- 实时同步游戏状态
- 多人协同游玩
- 断线重连支持
- 所有技能正常运作
- **页面刷新后保持游戏进度** ✨

## 🛠️ 技术架构

### 后端 (server/)
- **框架**：Express + Socket.io
- **功能**：
  - 房间管理系统
  - 玩家连接管理
  - 实时消息转发
  - 游戏状态同步
  - 自动断线清理

### 前端
- **通信**：Socket.io Client
- **状态管理**：Zustand + localStorage
- **状态持久化**：自动保存和恢复
- **新增组件**：
  - MainMenu - 主菜单（选择单机/联机）
  - Lobby - 多人大厅
  - Room - 房间等待界面
  - MultiplayerManager - 多人游戏管理器
  - GameStateStorage - 状态持久化工具

## 📝 使用说明

### 创建房间并邀请好友：
1. 启动服务器和前端
2. 打开 http://localhost:5173
3. 选择"多人联机"
4. 输入你的名字
5. 点击"创建新房间"
6. 将房间代码（如 ABC123）分享给好友
7. 选择你的角色
8. 等待好友加入并准备
9. 点击"开始游戏"

### 加入好友的房间：
1. 打开游戏
2. 选择"多人联机"
3. 输入你的名字
4. 输入好友的房间代码
5. 或从房间列表选择要加入的房间
6. 选择角色并点击"准备"
7. 等待房主开始游戏

## 🔧 服务器配置

服务器默认运行在端口 **3001**。

如需修改端口，编辑 `server/index.js`：
```javascript
const PORT = process.env.PORT || 3001;
```

## ❌ 故障排查

### WebSocket connection failed 错误

**问题**：看到错误 `WebSocket connection to 'ws://localhost:3001/socket.io/?EIO=4&transport=websocket' failed`

**原因**：游戏服务器没有启动

**解决方案**：

1. **启动服务器**（推荐方式）：
   ```bash
   npm run start:all
   ```

2. **或者分别启动**：

   在第一个终端窗口：
   ```bash
   npm run server:dev
   ```

   等待看到：
   ```
   🚀 多人游戏服务器运行在端口 3001
   🎮 等待玩家连接...
   ```

   在第二个终端窗口：
   ```bash
   npm run dev
   ```

3. **确认依赖已安装**：
   ```bash
   # 根目录
   npm install

   # 服务器目录
   cd server
   npm install
   cd ..
   ```

4. **检查端口是否被占用**：
   ```bash
   # Windows
   netstat -ano | findstr :3001

   # Mac/Linux
   lsof -i :3001
   ```

### 无法连接到服务器

如果看到"⚠️ 未连接到服务器"的警告：

1. **检查服务器日志** - 确保服务器正在运行
2. **点击"🔄 重新连接"按钮** - 在错误提示中
3. **刷新页面** - 如果重连失败
4. **检查防火墙** - 确保允许端口 3001

### 调试技巧

**查看服务器日志**：
服务器控制台会显示：
```
玩家连接: abc123
房间创建: XYZ789 by Player1
Player2 加入房间 XYZ789
```

**查看客户端日志**：
打开浏览器控制台（F12）：
```
正在连接到服务器: http://localhost:3001
✅ 已成功连接到多人游戏服务器
```

常见日志消息：
- `✅ 已成功连接到多人游戏服务器` - 连接成功
- `❌ 连接失败:` - 无法连接
- `🔄 正在尝试重新连接...` - 自动重连中

## 🌍 部署

### 部署服务器到云端：

1. **Heroku**：
```bash
cd server
git init
heroku create your-app-name
git add .
git commit -m "Deploy server"
git push heroku master
```

2. **Railway**：
- 连接 GitHub 仓库
- 选择 server 目录
- 自动部署

3. **修改前端连接地址**：
编辑 `src/multiplayer/MultiplayerManager.ts`：
```typescript
constructor(serverUrl: string = 'https://your-server-url.com') {
  this.serverUrl = serverUrl;
}
```

## 🎯 下一步开发

- [x] 页面刷新后状态保持 ✅
- [x] 自动重连到房间 ✅
- [ ] 游戏状态完全由服务器控制（防作弊）
- [ ] 观战模式
- [ ] 聊天系统
- [ ] 排行榜
- [ ] 房间密码
- [ ] 游戏中断线重连优化
- [ ] 游戏回放

## 🐛 已知问题

- 游戏逻辑仍在客户端执行（后续会移到服务器）
- 游戏进行中断线无法重新同步游戏状态（只能恢复界面）
- 没有聊天功能

## ⚠️ 注意事项

- **多人联机前必须先启动服务器**：使用 `npm run start:all` 或 `npm run server:dev`
- 刷新页面时会尝试恢复状态，请等待连接完成
- 如果房间已关闭，会自动返回大厅
- 浏览器的 localStorage 存储着你的游戏状态
- 清除浏览器缓存会丢失保存的状态
- 服务器重启后所有房间数据会清空（数据存储在内存中）

## 📞 反馈

如有问题或建议，欢迎提issue！

---

享受多人骆驼大赛吧！🐪🎮🌐
